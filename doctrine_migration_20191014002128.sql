-- Doctrine Migration File Generated on 2019-10-14 00:21:28

-- Version UniqueIds
SET FOREIGN_KEY_CHECKS = 0;;
-- Remove Foreign Keys;
ALTER TABLE address DROP FOREIGN KEY fk_address_city;
ALTER TABLE city DROP FOREIGN KEY fk_city_country;
ALTER TABLE customer DROP FOREIGN KEY fk_customer_address;
ALTER TABLE customer DROP FOREIGN KEY fk_customer_store;
ALTER TABLE film DROP FOREIGN KEY fk_film_language;
ALTER TABLE film DROP FOREIGN KEY fk_film_language_original;
ALTER TABLE film_actor DROP FOREIGN KEY fk_film_actor_actor;
ALTER TABLE film_actor DROP FOREIGN KEY fk_film_actor_film;
ALTER TABLE film_category DROP FOREIGN KEY fk_film_category_category;
ALTER TABLE film_category DROP FOREIGN KEY fk_film_category_film;
ALTER TABLE inventory DROP FOREIGN KEY fk_inventory_film;
ALTER TABLE inventory DROP FOREIGN KEY fk_inventory_store;
ALTER TABLE payment DROP FOREIGN KEY fk_payment_customer;
ALTER TABLE payment DROP FOREIGN KEY fk_payment_rental;
ALTER TABLE payment DROP FOREIGN KEY fk_payment_staff;
ALTER TABLE rental DROP FOREIGN KEY fk_rental_customer;
ALTER TABLE rental DROP FOREIGN KEY fk_rental_inventory;
ALTER TABLE rental DROP FOREIGN KEY fk_rental_staff;
ALTER TABLE staff DROP FOREIGN KEY fk_staff_address;
ALTER TABLE staff DROP FOREIGN KEY fk_staff_store;
ALTER TABLE store DROP FOREIGN KEY fk_store_address;
ALTER TABLE store DROP FOREIGN KEY fk_store_staff;
-- Migrar Primary Keys;
ALTER TABLE actor ADD UNIQUE(actor_id);
ALTER TABLE address ADD UNIQUE(address_id);
ALTER TABLE category ADD UNIQUE(category_id);
ALTER TABLE city ADD UNIQUE(city_id);
ALTER TABLE country ADD UNIQUE(country_id);
ALTER TABLE customer ADD UNIQUE(customer_id);
ALTER TABLE film ADD UNIQUE(film_id);
ALTER TABLE film_text ADD UNIQUE(film_id);
ALTER TABLE inventory ADD UNIQUE(inventory_id);
ALTER TABLE language ADD UNIQUE(language_id);
ALTER TABLE migration_versions ADD UNIQUE(version);
ALTER TABLE payment ADD UNIQUE(payment_id);
ALTER TABLE rental ADD UNIQUE(rental_id);
ALTER TABLE staff ADD UNIQUE(staff_id);
ALTER TABLE store ADD UNIQUE(store_id);
ALTER TABLE actor DROP PRIMARY KEY;
ALTER TABLE actor ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE address MODIFY address_id SMALLINT UNSIGNED NOT NULL;
ALTER TABLE address DROP PRIMARY KEY;
ALTER TABLE address ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE category MODIFY category_id TINYINT(1) NOT NULL;
ALTER TABLE category DROP PRIMARY KEY;
ALTER TABLE category ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE city MODIFY city_id SMALLINT UNSIGNED NOT NULL;
ALTER TABLE city DROP PRIMARY KEY;
ALTER TABLE city ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE country MODIFY country_id SMALLINT UNSIGNED NOT NULL;
ALTER TABLE country DROP PRIMARY KEY;
ALTER TABLE country ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE customer MODIFY customer_id SMALLINT UNSIGNED NOT NULL;
ALTER TABLE customer DROP PRIMARY KEY;
ALTER TABLE customer ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE film MODIFY film_id SMALLINT UNSIGNED NOT NULL;
ALTER TABLE film DROP PRIMARY KEY;
ALTER TABLE film ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE film_actor DROP PRIMARY KEY;
ALTER TABLE film_actor ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE film_category DROP PRIMARY KEY;
ALTER TABLE film_category ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE film_text DROP PRIMARY KEY;
ALTER TABLE film_text ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE inventory MODIFY inventory_id INT UNSIGNED NOT NULL;
ALTER TABLE inventory DROP PRIMARY KEY;
ALTER TABLE inventory ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE language MODIFY language_id TINYINT(1) NOT NULL;
ALTER TABLE language DROP PRIMARY KEY;
ALTER TABLE language ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE migration_versions DROP PRIMARY KEY;
ALTER TABLE migration_versions ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE payment MODIFY payment_id SMALLINT UNSIGNED NOT NULL;
ALTER TABLE payment DROP PRIMARY KEY;
ALTER TABLE payment ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE rental MODIFY rental_id INT NOT NULL;
ALTER TABLE rental DROP PRIMARY KEY;
ALTER TABLE rental ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE staff MODIFY staff_id TINYINT(1) NOT NULL;
ALTER TABLE staff DROP PRIMARY KEY;
ALTER TABLE staff ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
ALTER TABLE store MODIFY store_id TINYINT(1) NOT NULL;
ALTER TABLE store DROP PRIMARY KEY;
ALTER TABLE store ADD UNIQUE_ID CHAR(36) NOT NULL COMMENT '(DC2Type:guid)';
CREATE INDEX IDX_DD19A8A910DAF24A567F5183 ON film_actor (actor_id, film_id);
CREATE INDEX IDX_A4CBD6A8567F518312469DE2 ON film_category (film_id, category_id);
-- Populate Primary Keys;
UPDATE actor SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE actor ADD PRIMARY KEY (UNIQUE_ID);
UPDATE address SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE address ADD PRIMARY KEY (UNIQUE_ID);
UPDATE category SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE category ADD PRIMARY KEY (UNIQUE_ID);
UPDATE city SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE city ADD PRIMARY KEY (UNIQUE_ID);
UPDATE country SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE country ADD PRIMARY KEY (UNIQUE_ID);
UPDATE customer SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE customer ADD PRIMARY KEY (UNIQUE_ID);
UPDATE film SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE film ADD PRIMARY KEY (UNIQUE_ID);
UPDATE film_actor SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE film_actor ADD PRIMARY KEY (UNIQUE_ID);
UPDATE film_category SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE film_category ADD PRIMARY KEY (UNIQUE_ID);
UPDATE film_text SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE film_text ADD PRIMARY KEY (UNIQUE_ID);
UPDATE inventory SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE inventory ADD PRIMARY KEY (UNIQUE_ID);
UPDATE language SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE language ADD PRIMARY KEY (UNIQUE_ID);
UPDATE migration_versions SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE migration_versions ADD PRIMARY KEY (UNIQUE_ID);
UPDATE payment SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE payment ADD PRIMARY KEY (UNIQUE_ID);
UPDATE rental SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE rental ADD PRIMARY KEY (UNIQUE_ID);
UPDATE staff SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE staff ADD PRIMARY KEY (UNIQUE_ID);
UPDATE store SET UNIQUE_ID = (SELECT UUID());
ALTER TABLE store ADD PRIMARY KEY (UNIQUE_ID);
-- Recreate Foreign Keys;
ALTER TABLE address ADD CONSTRAINT fk_address_city FOREIGN KEY (city_id) REFERENCES city (city_id) ON UPDATE CASCADE;
ALTER TABLE city ADD CONSTRAINT fk_city_country FOREIGN KEY (country_id) REFERENCES country (country_id) ON UPDATE CASCADE;
ALTER TABLE customer ADD CONSTRAINT fk_customer_address FOREIGN KEY (address_id) REFERENCES address (address_id) ON UPDATE CASCADE;
ALTER TABLE customer ADD CONSTRAINT fk_customer_store FOREIGN KEY (store_id) REFERENCES store (store_id) ON UPDATE CASCADE;
ALTER TABLE film ADD CONSTRAINT fk_film_language FOREIGN KEY (language_id) REFERENCES language (language_id) ON UPDATE CASCADE;
ALTER TABLE film ADD CONSTRAINT fk_film_language_original FOREIGN KEY (original_language_id) REFERENCES language (language_id) ON UPDATE CASCADE;
ALTER TABLE film_actor ADD CONSTRAINT fk_film_actor_actor FOREIGN KEY (actor_id) REFERENCES actor (actor_id) ON UPDATE CASCADE;
ALTER TABLE film_actor ADD CONSTRAINT fk_film_actor_film FOREIGN KEY (film_id) REFERENCES film (film_id) ON UPDATE CASCADE;
ALTER TABLE film_category ADD CONSTRAINT fk_film_category_category FOREIGN KEY (category_id) REFERENCES category (category_id) ON UPDATE CASCADE;
ALTER TABLE film_category ADD CONSTRAINT fk_film_category_film FOREIGN KEY (film_id) REFERENCES film (film_id) ON UPDATE CASCADE;
ALTER TABLE inventory ADD CONSTRAINT fk_inventory_film FOREIGN KEY (film_id) REFERENCES film (film_id) ON UPDATE CASCADE;
ALTER TABLE inventory ADD CONSTRAINT fk_inventory_store FOREIGN KEY (store_id) REFERENCES store (store_id) ON UPDATE CASCADE;
ALTER TABLE payment ADD CONSTRAINT fk_payment_customer FOREIGN KEY (customer_id) REFERENCES customer (customer_id) ON UPDATE CASCADE;
ALTER TABLE payment ADD CONSTRAINT fk_payment_rental FOREIGN KEY (rental_id) REFERENCES rental (rental_id) ON UPDATE CASCADE ON DELETE SET NULL;
ALTER TABLE payment ADD CONSTRAINT fk_payment_staff FOREIGN KEY (staff_id) REFERENCES staff (staff_id) ON UPDATE CASCADE;
ALTER TABLE rental ADD CONSTRAINT fk_rental_customer FOREIGN KEY (customer_id) REFERENCES customer (customer_id) ON UPDATE CASCADE;
ALTER TABLE rental ADD CONSTRAINT fk_rental_inventory FOREIGN KEY (inventory_id) REFERENCES inventory (inventory_id) ON UPDATE CASCADE;
ALTER TABLE rental ADD CONSTRAINT fk_rental_staff FOREIGN KEY (staff_id) REFERENCES staff (staff_id) ON UPDATE CASCADE;
ALTER TABLE staff ADD CONSTRAINT fk_staff_address FOREIGN KEY (address_id) REFERENCES address (address_id) ON UPDATE CASCADE;
ALTER TABLE staff ADD CONSTRAINT fk_staff_store FOREIGN KEY (store_id) REFERENCES store (store_id) ON UPDATE CASCADE;
ALTER TABLE store ADD CONSTRAINT fk_store_address FOREIGN KEY (address_id) REFERENCES address (address_id) ON UPDATE CASCADE;
ALTER TABLE store ADD CONSTRAINT fk_store_staff FOREIGN KEY (manager_staff_id) REFERENCES staff (staff_id) ON UPDATE CASCADE;
INSERT INTO migration_versions (version, executed_at) VALUES ('UniqueIds', CURRENT_TIMESTAMP);
